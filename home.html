<!DOCTYPE html>
<html class="dark" lang="it">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard - Quiz Quest</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=VT323&amp;display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "var(--primary-color)",
                        "primary-dark": "var(--primary-dark)",
                        "secondary": "var(--secondary-color)",
                        "danger": "#ff0055",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101022",
                        "surface-dark": "#232348",
                        "retro-panel": "#191933",
                        "retro-border": "#323267",
                        "retro-text-muted": "#9292c9",
                    },
                    fontFamily: {
                        "display": ['"VT323"', "monospace"],
                        "mono": ["monospace"],
                        "sans": ['"VT323"', "monospace"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.125rem",
                        "lg": "0.25rem",
                        "xl": "0.5rem",
                        "full": "0.75rem"
                    },
                    boxShadow: {
                        'retro': '4px 4px 0px 0px rgba(0,0,0,0.5)',
                        'retro-sm': '2px 2px 0px 0px rgba(0,0,0,0.5)',
                        'retro-active': '0px 0px 0px 0px rgba(0,0,0,0)',
                    }
                },
            },
        }
    </script>
    <style>
        /* Retro scanline effect */
        .scanlines {
            background: linear-gradient(to bottom,
                    rgba(255, 255, 255, 0),
                    rgba(255, 255, 255, 0) 50%,
                    rgba(0, 0, 0, 0.2) 50%,
                    rgba(0, 0, 0, 0.2));
            background-size: 100% 4px;
            pointer-events: none;
        }

        .hidden {
            display: none !important;
        }

        /* Modal Overlay */
        .modal-overlay {
            background: rgba(16, 16, 34, 0.9);
            backdrop-filter: blur(4px);
        }
    </style>
    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed', err));
            });
        }
    </script>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white font-display overflow-x-hidden selection:bg-primary selection:text-white">
    <div class="relative min-h-screen flex flex-col pb-24">
        <!-- Scanline Overlay -->
        <div class="fixed inset-0 z-0 pointer-events-none scanlines opacity-20"></div>

        <!-- Header Section -->
        <header class="sticky top-0 z-20 bg-background-dark/95 backdrop-blur-sm border-b-2 border-primary/30">
            <div class="flex items-center justify-between p-4">
                <div class="flex items-center gap-3">
                    <div class="relative group cursor-pointer" id="profile-trigger">
                        <div class="size-10 bg-center bg-no-repeat bg-cover rounded border-2 border-white/20"
                            id="user-avatar-display" style='background-image: url("assets/avatars/1.png");'>
                        </div>
                        <div
                            class="absolute -bottom-1 -right-1 size-3 bg-secondary rounded-full border border-background-dark">
                        </div>
                    </div>
                    <div>
                        <h2 class="text-white text-base font-bold leading-tight tracking-tight" id="header-username">
                            PLAYER 1</h2>
                        <span class="text-xs text-primary font-bold tracking-widest uppercase" id="header-level">Lvl
                            01</span>
                    </div>
                </div>
                </button>
                <div class="flex items-center gap-2">
                    <!-- Notification Bell (Admin) -->
                    <button id="admin-notify-btn"
                        class="relative hidden p-2 rounded-full hover:bg-white/5 transition-colors group">
                        <!-- 8-bit Bell SVG -->
                        <svg id="notify-icon" class="w-6 h-6 text-white/50 group-hover:text-white transition-colors"
                            viewBox="0 0 24 24" fill="currentColor" shape-rendering="crispEdges">
                            <path
                                d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z" />
                        </svg>
                        <!-- Badge -->
                        <span id="notify-badge" class="absolute top-1 right-1 flex h-3 w-3 hidden">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-retro-red opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-retro-red"></span>
                        </span>
                    </button>
                    <button id="logout-btn"
                        class="flex items-center justify-center size-10 rounded border-2 border-transparent hover:bg-white/5 active:scale-95 transition-all text-white/70 hover:text-danger">
                        <span class="material-symbols-outlined">logout</span>
                    </button>
                </div>
            </div>
            <!-- XP Bar -->
            <div class="px-4 pb-3">
                <div class="flex justify-between items-end mb-1">
                    <span class="text-[10px] text-white/60 font-mono">XP</span>
                    <span class="text-[10px] text-white/60 font-mono" id="xp-display">0/100</span>
                </div>
                <div class="h-3 w-full bg-surface-dark rounded border border-white/10 relative overflow-hidden">
                    <div class="h-full bg-primary relative transition-all duration-1000" id="xp-bar" style="width: 0%;">
                        <!-- Shine effect on bar -->
                        <div class="absolute top-0 left-0 w-full h-[2px] bg-white/30"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="relative z-10 flex flex-col gap-6 p-4" id="subject-selection-screen">
            <!-- Daily Quest (Quick Actions) -->
            <section>
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-white text-xl font-bold tracking-tight flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">bolt</span>
                        QUICK PLAY
                    </h2>
                </div>

                <!-- Speed Mode Card -->
                <div
                    class="bg-surface-dark border-2 border-primary rounded-lg p-5 shadow-retro mb-4 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <span class="material-symbols-outlined text-6xl text-primary">speed</span>
                    </div>
                    <div class="flex justify-between items-start mb-4 relative z-10">
                        <div>
                            <p class="text-white/70 text-sm font-medium mb-1">Speed Mode</p>
                            <h3 class="text-2xl font-bold text-white">Blitz Run</h3>
                        </div>
                    </div>

                    <button
                        class="subject-btn w-full h-12 bg-primary hover:bg-primary-dark active:translate-y-1 active:shadow-retro-active text-white font-bold tracking-wider rounded border-b-4 border-r-4 border-primary-dark shadow-retro transition-all flex items-center justify-center gap-2 relative z-10"
                        data-subject="speed">
                        <span>START RUSH</span>
                        <span class="material-symbols-outlined text-sm">play_arrow</span>
                    </button>
                </div>

                <!-- Mini Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Leaderboard -->
                    <button
                        class="subject-btn group relative flex items-center justify-between p-4 bg-gradient-to-r from-retro-red/20 to-retro-red/10 border-2 border-retro-red rounded-lg hover:bg-retro-red/30 transition-all active:scale-[0.98] overflow-hidden"
                        data-subject="survival">
                        <div class="flex items-center gap-4 relative z-10">
                            <div
                                class="w-10 h-10 rounded bg-[#101022] border-2 border-retro-red flex items-center justify-center text-retro-red group-hover:text-white group-hover:bg-retro-red transition-colors shadow-[0_0_10px_rgba(255,0,0,0.4)]">
                                <span class="material-symbols-outlined">health_and_safety</span>
                            </div>
                            <div class="text-left">
                                <h3
                                    class="text-white font-bold uppercase tracking-wider text-sm group-hover:text-retro-red transition-colors">
                                    Survival Mode</h3>
                                <p class="text-[10px] text-white/50 font-mono uppercase tracking-widest">3 Lives •
                                    Infinite</p>
                            </div>
                        </div>
                        <span
                            class="material-symbols-outlined text-retro-red/50 group-hover:translate-x-1 transition-transform">chevron_right</span>
                    </button>
                    <!-- Laboratorio (New) -->
                    <a href="laboratorio.html"
                        class="bg-surface-dark border-2 border-green-500/50 rounded-lg p-4 relative overflow-hidden group hover:bg-green-500/10 transition-colors flex flex-col justify-between shadow-retro">
                        <div class="flex justify-between items-start">
                            <h3 class="text-green-500 font-bold uppercase tracking-wider text-sm">Laboratorio</h3>
                            <span class="material-symbols-outlined text-green-500">terminal</span>
                        </div>
                        <p class="text-[10px] text-white/50 font-mono uppercase tracking-widest mt-2">C Programming <br>
                            20 Levels</p>
                    </a>
                </div>
                <!-- Stats Row -->
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <a href="stats.html"
                        class="bg-surface-dark p-4 rounded border border-white/10 flex flex-row items-center justify-between hover:border-blue-500/50 transition-colors group">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-blue-500/10 rounded flex items-center justify-center">
                                <span
                                    class="material-symbols-outlined text-blue-500 group-hover:scale-110 transition-transform">equalizer</span>
                            </div>
                            <div>
                                <span class="text-xs text-white/60 font-mono uppercase block">Stats</span>
                                <span class="text-base font-bold text-white">Player Profile</span>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30">chevron_right</span>
                    </a>
                </div>
            </section>

            <!-- The Graveyard (Errors) & Favorites -->
            <section class="grid grid-cols-2 gap-4">
                <!-- Errors -->
                <a href="quiz.html?mode=errors"
                    class="bg-surface-dark border border-danger/30 rounded-lg p-4 relative overflow-hidden group hover:bg-danger/5 transition-colors">
                    <div class="absolute top-2 right-2 opacity-20">
                        <span class="material-symbols-outlined text-3xl text-danger">skull</span>
                    </div>
                    <h3 class="text-danger font-bold text-lg mb-1">Errors</h3>
                    <p class="text-white/50 text-xs">Retry mistakes</p>
                </a>

                <!-- Favorites -->
                <a href="quiz.html?mode=favorites"
                    class="bg-surface-dark border border-yellow-500/30 rounded-lg p-4 relative overflow-hidden group hover:bg-yellow-500/5 transition-colors">
                    <div class="absolute top-2 right-2 opacity-20">
                        <span class="material-symbols-outlined text-3xl text-yellow-500">star</span>
                    </div>
                    <h3 class="text-yellow-500 font-bold text-lg mb-1">Favs</h3>
                    <p class="text-white/50 text-xs">Saved items</p>
                </a>
            </section>

            <!-- Level Selection (Subjects) -->
            <section class="flex flex-col mt-2 gap-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-white text-sm font-bold tracking-widest uppercase flex items-center gap-2">
                        <span class="material-symbols-outlined text-secondary text-lg">grid_view</span>
                        Available Levels
                    </h2>
                    <!-- Install App Button (Hidden by default) -->
                    <button id="install-app-btn"
                        class="hidden text-xs bg-green-600/20 text-green-400 px-2 py-1 rounded border border-green-600/30 font-mono items-center gap-1">
                        <span class="material-symbols-outlined text-[14px]">download</span> INSTALL
                    </button>
                </div>

                <!-- Subject Cards Container -->
                <div class="flex flex-col gap-4">
                    <!-- Area Giuridica Heading -->
                    <div class="flex items-center gap-2 mt-2 mb-1">
                        <div class="h-[1px] bg-white/10 flex-1"></div>
                        <span class="text-[10px] text-white/40 uppercase tracking-widest font-mono">AREA
                            GIURIDICA</span>
                        <div class="h-[1px] bg-white/10 flex-1"></div>
                    </div>

                    <!-- Subject: Legislazione P.S. -->
                    <div
                        class="flex flex-row items-stretch bg-retro-panel rounded border border-retro-border hover:border-primary/50 transition-colors shadow-retro overflow-hidden h-28">
                        <div class="w-24 bg-cover bg-center shrink-0 border-r border-white/5"
                            style='background-image: url("https://images.unsplash.com/photo-1589829085413-56de8ae18c73?auto=format&fit=crop&q=80&w=300"); filter: grayscale(100%) contrast(120%);'>
                        </div>
                        <div class="flex flex-col justify-between p-3 grow">
                            <div>
                                <p class="text-retro-text-muted text-[10px] font-mono uppercase tracking-widest">WORLD
                                    1-1</p>
                                <h3 class="text-white text-sm font-bold uppercase tracking-tight leading-tight">
                                    Legislazione P.S.</h3>
                            </div>
                            <div class="flex items-end justify-between mt-1">
                                <span class="text-[10px] text-white/40">Pubblica Sicurezza</span>
                                <button
                                    class="subject-btn px-4 py-1.5 rounded bg-primary text-white text-xs font-bold uppercase tracking-wider shadow-[0_3px_0_0_#0c0cb5] active:translate-y-0.5 active:shadow-none transition-all"
                                    data-subject="ps">
                                    Start
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Subject: Diritto Costituzionale -->
                    <div
                        class="flex flex-row items-stretch bg-retro-panel rounded border border-retro-border hover:border-primary/50 transition-colors shadow-retro overflow-hidden h-28">
                        <div class="w-24 bg-cover bg-center shrink-0 border-r border-white/5"
                            style='background-image: url("https://images.unsplash.com/photo-1555848962-6e79363ec58f?auto=format&fit=crop&q=80&w=300"); filter: grayscale(100%) contrast(120%);'>
                        </div>
                        <div class="flex flex-col justify-between p-3 grow">
                            <div>
                                <p class="text-retro-text-muted text-[10px] font-mono uppercase tracking-widest">WORLD
                                    1-2</p>
                                <h3 class="text-white text-sm font-bold uppercase tracking-tight leading-tight">Dir.
                                    Costituzionale</h3>
                            </div>
                            <div class="flex items-end justify-between mt-1">
                                <span class="text-[10px] text-white/40">Costituzione</span>
                                <button
                                    class="subject-btn px-4 py-1.5 rounded bg-primary text-white text-xs font-bold uppercase tracking-wider shadow-[0_3px_0_0_#0c0cb5] active:translate-y-0.5 active:shadow-none transition-all"
                                    data-subject="costituzionale">
                                    Start
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Subject: Diritto Penale -->
                    <div
                        class="flex flex-row items-stretch bg-retro-panel rounded border border-retro-border hover:border-primary/50 transition-colors shadow-retro overflow-hidden h-28">
                        <div class="w-24 bg-cover bg-center shrink-0 border-r border-white/5"
                            style='background-image: url("https://images.unsplash.com/photo-1505664194779-8beaceb93744?auto=format&fit=crop&q=80&w=300"); filter: grayscale(100%) contrast(120%);'>
                        </div>
                        <div class="flex flex-col justify-between p-3 grow">
                            <div>
                                <p class="text-retro-text-muted text-[10px] font-mono uppercase tracking-widest">WORLD
                                    1-3</p>
                                <h3 class="text-white text-sm font-bold uppercase tracking-tight leading-tight">Diritto
                                    Penale</h3>
                            </div>
                            <div class="flex items-end justify-between mt-1">
                                <span class="text-[10px] text-white/40">Codice Penale</span>
                                <button
                                    class="subject-btn px-4 py-1.5 rounded bg-primary text-white text-xs font-bold uppercase tracking-wider shadow-[0_3px_0_0_#0c0cb5] active:translate-y-0.5 active:shadow-none transition-all"
                                    data-subject="penale">
                                    Start
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Subject: Procedura Penale -->
                    <div
                        class="flex flex-row items-stretch bg-retro-panel rounded border border-retro-border hover:border-primary/50 transition-colors shadow-retro overflow-hidden h-28">
                        <div class="w-24 bg-cover bg-center shrink-0 border-r border-white/5"
                            style='background-image: url("https://images.unsplash.com/photo-1453728013993-6d66e9c9123a?auto=format&fit=crop&q=80&w=300"); filter: grayscale(100%) contrast(120%);'>
                        </div>
                        <div class="flex flex-col justify-between p-3 grow">
                            <div>
                                <p class="text-retro-text-muted text-[10px] font-mono uppercase tracking-widest">WORLD
                                    1-4</p>
                                <h3 class="text-white text-sm font-bold uppercase tracking-tight leading-tight">
                                    Procedura Penale</h3>
                            </div>
                            <div class="flex items-end justify-between mt-1">
                                <span class="text-[10px] text-white/40">Processo</span>
                                <button
                                    class="subject-btn px-4 py-1.5 rounded bg-primary text-white text-xs font-bold uppercase tracking-wider shadow-[0_3px_0_0_#0c0cb5] active:translate-y-0.5 active:shadow-none transition-all"
                                    data-subject="procedura_penale">
                                    Start
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Subject: Normativa Disciplinare -->
                    <div
                        class="flex flex-row items-stretch bg-retro-panel rounded border border-retro-border hover:border-primary/50 transition-colors shadow-retro overflow-hidden h-28">
                        <div class="w-24 bg-cover bg-center shrink-0 border-r border-white/5"
                            style='background-image: url("https://images.unsplash.com/photo-1541888946425-d81bb19240f5?auto=format&fit=crop&q=80&w=300"); filter: grayscale(100%) contrast(120%);'>
                        </div>
                        <div class="flex flex-col justify-between p-3 grow">
                            <div>
                                <p class="text-retro-text-muted text-[10px] font-mono uppercase tracking-widest">WORLD
                                    1-5</p>
                                <h3 class="text-white text-sm font-bold uppercase tracking-tight leading-tight">
                                    Normativa Disc.</h3>
                            </div>
                            <div class="flex items-end justify-between mt-1">
                                <span class="text-[10px] text-white/40">Disciplina</span>
                                <button
                                    class="subject-btn px-4 py-1.5 rounded bg-primary text-white text-xs font-bold uppercase tracking-wider shadow-[0_3px_0_0_#0c0cb5] active:translate-y-0.5 active:shadow-none transition-all"
                                    data-subject="normativa">
                                    Start
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Area Tecnica Heading -->
                    <div class="flex items-center gap-2 mt-4 mb-1">
                        <div class="h-[1px] bg-white/10 flex-1"></div>
                        <span class="text-[10px] text-green-400/60 uppercase tracking-widest font-mono">AREA
                            TECNICA</span>
                        <div class="h-[1px] bg-white/10 flex-1"></div>
                    </div>

                    <!-- Subject: Informatica -->
                    <div
                        class="flex flex-row items-stretch bg-retro-panel rounded border border-retro-border hover:border-secondary/50 transition-colors shadow-retro overflow-hidden h-28">
                        <div class="w-24 bg-cover bg-center shrink-0 border-r border-white/5"
                            style='background-image: url("https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&q=80&w=300"); filter: grayscale(100%) contrast(120%);'>
                        </div>
                        <div class="flex flex-col justify-between p-3 grow">
                            <div>
                                <p class="text-retro-text-muted text-[10px] font-mono uppercase tracking-widest">WORLD
                                    2-1</p>
                                <h3 class="text-white text-sm font-bold uppercase tracking-tight leading-tight">
                                    Informatica</h3>
                            </div>
                            <div class="flex items-end justify-between mt-1">
                                <span class="text-[10px] text-white/40">Technology</span>
                                <button
                                    class="subject-btn px-4 py-1.5 rounded bg-secondary text-white text-xs font-bold uppercase tracking-wider shadow-[0_3px_0_0_#059669] active:translate-y-0.5 active:shadow-none transition-all"
                                    data-subject="informatica">
                                    Start
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Approfondimenti Heading -->
                    <div class="flex items-center gap-2 mt-4 mb-1">
                        <div class="h-[1px] bg-white/10 flex-1"></div>
                        <span
                            class="text-[10px] text-retro-purple/80 uppercase tracking-widest font-mono">APPROFONDIMENTI</span>
                        <div class="h-[1px] bg-white/10 flex-1"></div>
                    </div>

                    <!-- Subject: Approfondimenti (Deep Dive) -->
                    <div
                        class="flex flex-row items-stretch bg-retro-panel rounded border border-retro-border hover:border-retro-purple/50 transition-colors shadow-retro overflow-hidden h-28">
                        <div class="w-24 bg-cover bg-center shrink-0 border-r border-white/5"
                            style='background-image: url("assets/deep_dive_bg.png"); filter: grayscale(20%) contrast(120%);'>
                        </div>
                        <div class="flex flex-col justify-between p-3 grow">
                            <div>
                                <p class="text-retro-text-muted text-[10px] font-mono uppercase tracking-widest">BSIDE
                                    LEVELS</p>
                                <h3 class="text-white text-sm font-bold uppercase tracking-tight leading-tight">
                                    Approfondimenti</h3>
                            </div>
                            <div class="flex items-end justify-between mt-1">
                                <span class="text-[10px] text-white/40">Database Esterno</span>
                                <button id="deep-dive-btn"
                                    class="subject-btn relative z-10 px-4 py-1.5 rounded bg-retro-purple text-white text-xs font-bold uppercase tracking-wider shadow-[0_3px_0_0_#6d28d9] active:translate-y-0.5 active:shadow-none transition-all cursor-pointer hover:brightness-110">
                                    Open
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Admin Button (Hidden) -->
            <div class="flex justify-center mt-6">
                <a href="admin.html" id="admin-btn"
                    class="hidden px-4 py-2 border border-danger/50 text-danger text-xs font-bold uppercase tracking-widest hover:bg-danger/10 rounded transition-colors">
                    Admin Panel
                </a>
            </div>

            <div class="h-6"></div>
        </main>

        <!-- Navigation Dock -->
        <nav
            class="fixed bottom-0 left-0 w-full z-40 px-4 pb-4 pt-2 bg-gradient-to-t from-background-dark via-background-dark to-transparent">
            <div
                class="bg-[#1a1a2e] border-2 border-white/10 rounded-xl shadow-2xl p-2 flex justify-around items-center relative overflow-hidden">
                <!-- Nav Item: Home -->
                <button class="flex flex-col items-center gap-1 p-2 w-14 rounded group relative"
                    onclick="window.scrollTo({top:0, behavior:'smooth'})">
                    <div
                        class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 rounded transition-opacity">
                    </div>
                    <span
                        class="material-symbols-outlined text-primary group-hover:scale-110 transition-transform filled"
                        style="font-variation-settings: 'FILL' 1;">home</span>
                    <span class="text-[10px] text-white/90 font-bold">Base</span>
                    <!-- Active Indicator -->
                    <div class="absolute -bottom-1 w-8 h-1 bg-primary rounded-t-full"></div>
                </button>

                <!-- Nav Item: Play (Scrolls to Levels) -->
                <button class="flex flex-col items-center gap-1 p-2 w-14 rounded group"
                    onclick="document.querySelector('section:nth-of-type(3)').scrollIntoView({behavior:'smooth'})">
                    <span
                        class="material-symbols-outlined text-white/50 group-hover:text-white transition-colors">sports_esports</span>
                    <span class="text-[10px] text-white/50 font-bold group-hover:text-white">Play</span>
                </button>

                <!-- Center Action Button (Random Quiz maybe?) -->
                <div class="relative -top-6">
                    <button
                        class="subject-btn size-16 rounded-full bg-primary border-4 border-background-dark shadow-retro hover:scale-105 active:scale-95 active:shadow-retro-active transition-all flex items-center justify-center text-white"
                        data-subject="all">
                        <span class="material-symbols-outlined" style="font-size: 32px;">shuffle</span>
                    </button>
                </div>

                <!-- Nav Item: Leaderboard -->
                <button class="flex flex-col items-center gap-1 p-2 w-14 rounded group" id="nav-rank-btn">
                    <span
                        class="material-symbols-outlined text-white/50 group-hover:text-white transition-colors">leaderboard</span>
                    <span class="text-[10px] text-white/50 font-bold group-hover:text-white">Rank</span>
                </button>

                <!-- Nav Item: Profile -->
                <button class="flex flex-col items-center gap-1 p-2 w-14 rounded group"
                    onclick="location.href='stats.html'">
                    <span
                        class="material-symbols-outlined text-white/50 group-hover:text-white transition-colors">person</span>
                    <span class="text-[10px] text-white/50 font-bold group-hover:text-white">Char</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- START SCREEN MODAL (Mission Briefing) -->
    <div id="start-screen"
        class="fixed inset-0 z-50 flex items-center justify-center px-4 hidden modal-overlay opacity-0 transition-opacity duration-300">
        <div class="bg-surface-dark border-2 border-primary w-full max-w-sm rounded-lg shadow-2xl transform scale-95 transition-transform duration-300"
            id="mission-modal-card">
            <!-- Modal Header -->
            <div class="bg-primary/20 border-b border-primary/30 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold uppercase tracking-widest flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">article</span>
                    Mission Briefing
                </h3>
                <button id="close-modal-btn" class="text-white/50 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-6 flex flex-col gap-6">
                <div class="text-center">
                    <p class="text-white/50 text-xs font-mono uppercase mb-1">TARGET SUBJECT</p>
                    <h2 id="subject-title" class="text-2xl font-bold text-white uppercase leading-none">LEGISLAZIONE
                        P.S.</h2>
                </div>

                <!-- Settings -->
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-xs text-secondary font-bold uppercase tracking-wider">Length</label>
                        <select id="question-count"
                            class="w-full bg-background-dark border border-white/10 rounded px-3 py-2 text-white text-sm focus:border-primary focus:ring-0">
                            <option value="10">Short Mission (10 Q)</option>
                            <option value="20" selected>Standard Op (20 Q)</option>
                            <option value="50">Endurance (50 Q)</option>
                            <option value="100">Marathon (100 Q)</option>
                            <option value="all">Full Assault (All)</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs text-secondary font-bold uppercase tracking-wider">Difficulty</label>
                        <select id="difficulty-select"
                            class="w-full bg-background-dark border border-white/10 rounded px-3 py-2 text-white text-sm focus:border-primary focus:ring-0">
                            <option value="mixed" selected>Adaptive (Mixed)</option>
                            <option value="1">Recruit (Easy)</option>
                            <option value="2">Veteran (Medium)</option>
                            <option value="3">Elite (Hard)</option>
                        </select>
                    </div>

                    <!-- Subject Selection (Hidden by default, shown for 'all') -->
                    <div class="space-y-1 hidden" id="subject-filter-container">
                        <label class="text-xs text-secondary font-bold uppercase tracking-wider">Include
                            Subjects</label>
                        <div class="w-full bg-background-dark border border-white/10 rounded px-3 py-2 max-h-32 overflow-y-auto scrollbar-hide space-y-2"
                            id="subject-checklist">
                            <!-- Checkboxes injected by JS -->
                        </div>
                    </div>
                </div>

                <!-- Action -->
                <button id="start-btn"
                    class="w-full py-4 bg-primary hover:bg-primary-dark text-white font-bold uppercase tracking-[0.2em] rounded shadow-retro hover:translate-y-[1px] hover:shadow-none transition-all">
                    DEPLOY
                </button>
            </div>
        </div>
    </div>

    <!-- LEADERBOARD MODAL -->
    <div id="leaderboard-screen" class="fixed inset-0 z-50 flex items-center justify-center px-4 hidden modal-overlay">
        <div
            class="bg-surface-dark border-2 border-yellow-500 w-full max-w-sm rounded-lg shadow-2xl flex flex-col max-h-[80vh]">
            <div class="bg-yellow-500/20 border-b border-yellow-500/30 p-4 flex justify-between items-center shrink-0">
                <h3 class="text-yellow-500 font-bold uppercase tracking-widest flex items-center gap-2">
                    <span class="material-symbols-outlined">emoji_events</span>
                    Hall of Fame
                </h3>
                <button id="back-from-leaderboard-btn" class="text-white/50 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-yellow-500/30 bg-black/20">
                <button
                    class="flex-1 py-3 text-xs font-bold uppercase tracking-wider text-yellow-500 border-b-2 border-yellow-500 bg-yellow-500/10 transition-colors leaderboard-tab"
                    data-tab="total">
                    Total XP
                </button>
                <button
                    class="flex-1 py-3 text-xs font-bold uppercase tracking-wider text-white/50 hover:text-white transition-colors leaderboard-tab"
                    data-tab="survival">
                    Survival
                </button>
                <button
                    class="flex-1 py-3 text-xs font-bold uppercase tracking-wider text-white/50 hover:text-white transition-colors leaderboard-tab"
                    data-tab="speed">
                    Speed
                </button>
            </div>

            <div class="overflow-y-auto p-0 scrollbar-hide">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-black/20 text-xs uppercase text-white/50 font-mono sticky top-0 backdrop-blur-md">
                        <tr>
                            <th class="p-3">Rank</th>
                            <th class="p-3">Player</th>
                            <th class="p-3 text-right">XP</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="text-sm">
                        <!-- Loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DEEP DIVE MODAL -->
    <div id="deep-dive-modal"
        class="fixed inset-0 z-50 flex items-center justify-center px-4 hidden modal-overlay opacity-0 transition-opacity duration-300">
        <div
            class="bg-surface-dark border-2 border-retro-purple w-full max-w-sm rounded-lg shadow-2xl transform scale-95 transition-transform duration-300 flex flex-col max-h-[85vh]">
            <!-- Header -->
            <div
                class="bg-retro-purple/20 border-b border-retro-purple/30 p-4 flex justify-between items-center shrink-0">
                <h3 class="text-retro-purple font-bold uppercase tracking-widest flex items-center gap-2">
                    <span class="material-symbols-outlined">dataset</span>
                    DATABASE ESTERNO
                </h3>
                <button id="close-deep-dive-btn" class="text-white/50 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-4 bg-black/40 shrink-0 border-b border-white/5">
                <div class="flex items-start gap-3">
                    <span class="material-symbols-outlined text-retro-purple text-2xl mt-1">info</span>
                    <div>
                        <p class="text-sm text-white font-bold mb-1">Simulazione Isolata</p>
                        <p class="text-xs text-white/60 leading-relaxed">
                            Questi quiz utilizzano domande dal database secondario.
                            <span class="text-retro-purple">Nessun XP</span> verrà assegnato e i risultati non
                            influiranno sulla classifica.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Categories List -->
            <div id="deep-dive-list" class="overflow-y-auto grow p-4 scrollbar-hide space-y-2">
                <!-- Injected by JS -->
                <div class="flex items-center justify-center py-8">
                    <span class="material-symbols-outlined animate-spin text-retro-purple text-3xl">sync</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module" src="leaderboard.js"></script>
    <script type="module" src="leaderboard.js"></script>
    <script type="module" src="theme.js"></script>
    <script src="home.js?v=3"></script>
    <script type="module">
        import { UserData } from './user-data.js';
        import { auth } from './firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { Theme } from './theme.js';

        document.addEventListener('DOMContentLoaded', () => {
            // Handle Modal Transitions matches
            const startScreen = document.getElementById('start-screen');
            const modalObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.target.classList.contains('active')) {
                        mutation.target.classList.remove('hidden');
                        setTimeout(() => {
                            mutation.target.classList.remove('opacity-0');
                            mutation.target.querySelector('div').classList.remove('scale-95');
                            mutation.target.querySelector('div').classList.add('scale-100');
                        }, 10);
                    } else {
                        if (!mutation.target.classList.contains('hidden')) {
                            mutation.target.classList.add('opacity-0');
                            mutation.target.querySelector('div').classList.remove('scale-100');
                            mutation.target.querySelector('div').classList.add('scale-95');
                            setTimeout(() => {
                                mutation.target.classList.add('hidden');
                            }, 300);
                        }
                    }
                });
            });
            // We'll manually handle classes in home.js, but this helper can smooth animations if we toggle specific classes

            // ... (Rest of logic will be handled by updated home.js) ...
            const user = localStorage.getItem('quizUser');
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('header-username').textContent = user;

            onAuthStateChanged(auth, async (firebaseUser) => {
                if (firebaseUser) {
                    const data = await UserData.getUserData();
                    if (data) {
                        if (data.theme) {
                            Theme.setTheme(data.theme);
                        }
                        const lvl = data.level || 1;
                        const exp = data.exp || 0;

                        // Calculate Thresholds
                        const thresholds = UserData.getLevelThresholds();
                        const currentThreshold = thresholds[lvl] || 999999;
                        const prevThreshold = thresholds[lvl - 1] || 0;
                        const levelProgress = exp - prevThreshold;
                        const levelTotal = currentThreshold - prevThreshold;

                        let pct = 0;
                        if (levelTotal > 0) {
                            pct = Math.min(100, Math.max(0, (levelProgress / levelTotal) * 100));
                        }

                        document.getElementById('header-level').textContent = `Lvl ${lvl}`;
                        // Update specific XP display (current progress / needed for next level)
                        document.getElementById('xp-display').textContent = `${levelProgress}/${levelTotal}`;

                        // Update Bar Width
                        const xpBar = document.getElementById('xp-bar');
                        if (xpBar) xpBar.style.width = `${pct}%`;

                        // Avatar
                        const avatarEl = document.getElementById('user-avatar-display');
                        const avatarLvl = Math.min(lvl, 10);
                        if (avatarEl) avatarEl.style.backgroundImage = `url("assets/avatars/${avatarLvl}.png")`;

                        // Admin
                        if (data.role === 'admin' || user === 'admin') {
                            document.getElementById('admin-btn').classList.remove('hidden');

                            // Notification System
                            const notifyBtn = document.getElementById('admin-notify-btn');
                            const notifyBadge = document.getElementById('notify-badge');
                            const notifyIcon = document.getElementById('notify-icon');

                            if (notifyBtn) {
                                notifyBtn.classList.remove('hidden');

                                // Initial check
                                let currentUnread = 0;
                                const checkReports = async () => {
                                    try {
                                        currentUnread = await UserData.getUnreadReportsCount();
                                        if (currentUnread > 0) {
                                            notifyBadge.classList.remove('hidden');
                                            notifyIcon.classList.add('text-retro-yellow', 'animate-pulse');
                                            notifyIcon.classList.remove('text-white/50');
                                        } else {
                                            notifyBadge.classList.add('hidden');
                                            notifyIcon.classList.remove('text-retro-yellow', 'animate-pulse');
                                            notifyIcon.classList.add('text-white/50');
                                        }
                                    } catch (e) { console.error("Notify check failed", e); }
                                };
                                checkReports();

                                notifyBtn.addEventListener('click', async () => {
                                    // Refresh count on click just to be sure
                                    await checkReports();
                                    if (currentUnread > 0) {
                                        alert(`Hai ${currentUnread} nuove segnalazioni nell'area Admin.\n\nVerranno segnate come lette.`);
                                        await UserData.markAllReportsAsRead();
                                        // Reset UI immediately
                                        notifyBadge.classList.add('hidden');
                                        notifyIcon.classList.remove('text-retro-yellow', 'animate-pulse');
                                        notifyIcon.classList.add('text-white/50');
                                        currentUnread = 0;
                                    } else {
                                        alert("Nessuna nuova segnalazione.");
                                    }
                                });
                            }
                        }
                    }
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('quizUser');
                window.location.href = 'index.html';
            });
        });
    </script>
</body>

</html>