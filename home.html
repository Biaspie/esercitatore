<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esercitatore corso 9 VIT</title>
    <link rel="stylesheet" href="style.css?v=5">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
</head>

<body>
    <!-- Dynamic Background -->
    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <!-- Glass Container -->
    <div class="container">
        <header style="position: relative;">
            <h1 id="app-title">Esercitatore corso 9 VIT</h1>
            <div id="user-auth-section"
                style="position: absolute; top: 0; right: 0; display: flex; align-items: center; gap: 1rem;">
                <span id="user-greeting" style="font-size: 0.9rem; color: var(--text-muted); display: none;"></span>
                <button id="logout-btn" class="btn secondary-btn"
                    style="padding: 0.4rem 0.8rem; font-size: 0.8rem; display: none;">Esci</button>
            </div>
        </header>

        <main style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
            <!-- Subject Selection Screen -->
            <div id="subject-selection-screen" class="screen active">
                <h2 style="margin-bottom: 1rem; font-size: 1.5rem;">Scegli la Materia</h2>

                <div class="subjects-scroll-container" style="gap: 1rem;">

                    <!-- Quick Actions Section -->
                    <div class="category-section">
                        <h3 class="category-title"
                            style="font-size: 0.9rem; margin-bottom: 0.5rem; opacity: 0.8; border-left-color: #FFD700;">
                            Azioni Rapide</h3>
                        <div class="subject-grid"
                            style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem;">
                            <button class="btn subject-btn speed-mode-btn" data-subject="speed"
                                style="background: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%); border: none; font-size: 0.9rem; height: 70px;">
                                ‚ö° Speed Mode
                            </button>
                            <a href="quiz.html?mode=favorites" class="btn subject-btn"
                                style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); border: none; font-size: 0.9rem; height: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                                <span style="font-size: 1.5rem; margin-bottom: 0.2rem;">‚≠ê</span>
                                Preferiti
                            </a>
                            <a href="quiz.html?mode=errors" class="btn subject-btn"
                                style="background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); border: none; font-size: 0.9rem; height: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                                <span style="font-size: 1.5rem; margin-bottom: 0.2rem;">‚ùå</span>
                                Errori
                            </a>
                            <button id="leaderboard-btn" class="btn secondary-btn"
                                style="background: rgba(255, 215, 0, 0.1); border: 1px solid #FFD700; color: #FFD700; font-size: 0.9rem; height: 70px; display: flex; flex-direction: column; justify-content: center; gap: 0.5rem;">
                                üèÜ Classifica
                            </button>
                            <button class="btn subject-btn primary-btn" data-subject="all"
                                style="font-size: 0.9rem; height: 70px;">
                                üìö Tutte le materie
                            </button>
                            <a href="manuals.html" class="btn secondary-btn"
                                style="display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.9rem; text-decoration: none; height: 70px; gap: 0.5rem;">
                                üìñ Manuali
                            </a>
                        </div>
                    </div>

                    <!-- Test History Section -->
                    <div class="category-section">
                        <h3 class="category-title"
                            style="font-size: 0.9rem; margin-bottom: 0.5rem; opacity: 0.8; border-left-color: #3b82f6;">
                            Cronologia Recente</h3>
                        <div id="history-container" class="subject-grid"
                            style="grid-template-columns: 1fr; gap: 0.8rem;">
                            <div style="text-align: center; color: var(--text-muted); padding: 1rem;">Caricamento
                                cronologia...</div>
                        </div>
                    </div>

                    <!-- Area Giuridica -->
                    <div class="category-section">
                        <h3 class="category-title" style="font-size: 0.9rem; margin-bottom: 0.5rem; opacity: 0.8;">Area
                            Giuridica</h3>
                        <div class="subject-grid"
                            style="gap: 0.8rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                            <button class="btn subject-btn" data-subject="ps"
                                style="height: 70px; font-size: 0.9rem;">Legislazione P.S.</button>
                            <button class="btn subject-btn" data-subject="costituzionale"
                                style="height: 70px; font-size: 0.9rem;">Diritto Costituzionale</button>
                            <button class="btn subject-btn" data-subject="penale"
                                style="height: 70px; font-size: 0.9rem;">Diritto Penale</button>
                            <button class="btn subject-btn" data-subject="procedura_penale"
                                style="height: 70px; font-size: 0.9rem;">Procedura Penale</button>
                            <button class="btn subject-btn" data-subject="normativa"
                                style="height: 70px; font-size: 0.9rem;">Normativa Disciplinare</button>
                        </div>
                    </div>

                    <!-- Area Tecnica -->
                    <div class="category-section">
                        <h3 class="category-title" style="font-size: 0.9rem; margin-bottom: 0.5rem; opacity: 0.8;">Area
                            Tecnica</h3>
                        <div class="subject-grid"
                            style="gap: 0.8rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                            <button class="btn subject-btn" data-subject="informatica"
                                style="height: 70px; font-size: 0.9rem;">Informatica</button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Start Screen -->
            <div id="start-screen" class="screen">
                <h2 id="subject-title">Benvenuto al Quiz</h2>

                <div class="settings-container"
                    style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 16px; margin: 2rem 0;">
                    <label for="question-count"
                        style="display: block; margin-bottom: 1rem; color: var(--text-muted); font-weight: 500;">
                        Numero di domande:
                    </label>
                    <select id="question-count" class="settings-select"
                        style="width: 100%; padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.2); color: var(--text-color); font-size: 1rem; outline: none; cursor: pointer;">
                        <option value="10">10 Domande</option>
                        <option value="20" selected>20 Domande</option>
                        <option value="50">50 Domande</option>
                        <option value="100">100 Domande</option>
                        <option value="all">Tutte le Domande</option>
                    </select>

                    <label for="difficulty-select"
                        style="display: block; margin-top: 1rem; margin-bottom: 1rem; color: var(--text-muted); font-weight: 500;">
                        Livello di Difficolt√†:
                    </label>
                    <select id="difficulty-select" class="settings-select"
                        style="width: 100%; padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.2); color: var(--text-color); font-size: 1rem; outline: none; cursor: pointer;">
                        <option value="mixed" selected>Mista (Tutte le difficolt√†)</option>
                        <option value="1">Facile (‚òÖ‚òÜ‚òÜ)</option>
                        <option value="2">Media (‚òÖ‚òÖ‚òÜ)</option>
                        <option value="3">Difficile (‚òÖ‚òÖ‚òÖ)</option>
                    </select>
                </div>

                <div style="margin-top: auto; display: flex; flex-direction: column; gap: 1rem;">
                    <button id="start-btn" class="btn primary-btn" style="width: 100%; font-size: 1.1rem;">
                        Avvia Quiz
                    </button>
                    <button id="back-to-subjects-btn" class="btn secondary-btn" style="width: 100%;">
                        Torna alle Materie
                    </button>
                </div>
            </div>

            <!-- Leaderboard Screen -->
            <div id="leaderboard-screen" class="screen">
                <h2 style="color: #FFD700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);">üèÜ Classifica Globale</h2>
                <div class="leaderboard-container">
                    <table id="leaderboard-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nome</th>
                                <th>Punteggio</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr>
                                <td colspan="3">Caricamento...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="navigation-buttons">
                    <button id="back-from-leaderboard-btn" class="btn secondary-btn">Indietro</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module" src="leaderboard.js"></script>
    <script src="home.js?v=1"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = localStorage.getItem('quizUser');

            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            const logoutBtn = document.getElementById('logout-btn');
            const userGreeting = document.getElementById('user-greeting');

            userGreeting.style.display = 'block';
            userGreeting.textContent = `Ciao, ${user}`;
            logoutBtn.style.display = 'block';

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('quizUser');
                window.location.href = 'index.html';
            });

            // Load History
            import('./user-data.js').then(async ({ UserData }) => {
                const { auth } = await import('./firebase-config.js');
                const { onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const historyContainer = document.getElementById('history-container');
                        const history = await UserData.getRecentHistory(3);

                        if (history.length === 0) {
                            historyContainer.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.9rem;">Nessun test recente.</div>';
                            return;
                        }

                        historyContainer.innerHTML = '';
                        history.forEach(test => {
                            const date = new Date(test.timestamp).toLocaleDateString('it-IT', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                            const scoreClass = (test.score / test.totalQuestions) >= 0.6 ? '#10b981' : '#ef4444';

                            const card = document.createElement('a');
                            card.href = `quiz.html?mode=history&id=${test.id}`;
                            card.className = 'btn secondary-btn';
                            card.style.display = 'flex';
                            card.style.justifyContent = 'space-between';
                            card.style.alignItems = 'center';
                            card.style.textDecoration = 'none';
                            card.style.padding = '1rem';
                            card.style.height = 'auto';

                            card.innerHTML = `
                                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                    <span style="font-weight: 600; font-size: 0.95rem; color: var(--text-color);">${test.subject === 'speed' ? '‚ö° Speed Mode' : (test.subject === 'all' ? 'üìö Tutte le materie' : test.subject)}</span>
                                    <span style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem;">${date}</span>
                                </div>
                                <div style="text-align: right;">
                                    <span style="font-weight: 700; font-size: 1.1rem; color: ${scoreClass};">${test.score}/${test.totalQuestions}</span>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Punti</div>
                                </div>
                            `;
                            historyContainer.appendChild(card);
                        });
                    }
                });
            });
        });
    </script>
</body>

</html>